# Курсовая работа по курсу 'проектирование высоконагруженных систем' Технопарка

# Uber / Яндекс.Такси

## 1. Тема и целевая аудитория

### Целевая аудитория

* Сегменты: Несколько стран, например: Россия, Беларусь, Казахстан, Израиль, в нашем случае будем описывать локализацию по России
* Количество активных пользователей в месяц ~ 20 млн активных пользователей в месяц
* В возрастная категория: 18-60 лет

### Ключевой функционал

* Заказ такси пользователем на карте
* Получение заказа водителем и его выполнение
* Отслеживание местоположения таксиста при заказе поездки

## 2. Расчет нагрузки

### Продуктовые метрики

Рынок такси в 2020 году соответствует рынку такси в 2018 и кол-во поездок в день ~ 7млн. Кол-во поездок в сутки в Москве составляет ~900тыс, при этом доля яндекса составляет 70%. В России доля яндекса составляет 27%. Отсюда следует что доля яндекса по всей России ~ 42%, итого ~ 3млн поездок в день. Треть пользуется такси ~ 20 раз месяц, оставщаяся часть ~2 раза в месяц, итого кол-во уникальных пользователей в месяц ~ 20 млн. Таким образом кол-во уникальных пользователей в день ~ 3 млн и около 200 тыс водителей.

### RPS

#### Расчет пути и заказ такси

Совершается каждым активным пользователем 1-2 раза в сутки. Средний rps:

`3 * 10^6 * 1.5 / 24 / 60 / 60 = 52 rps`

#### Отзыв на поездку

В среднем 50% пользователей оставляют отзывы на поездку

Совершается каждым активным пользователем два раза в сутки. Средний rps:

`3 * 10^6 * 1.5 * 0.5 / 24 / 60 / 60 = 26 rps`

#### Получение заказа таксистом

Равен количеству заказов такси. Средний rps:

`3 * 10^6 * 1.5 / 24 / 60 / 60 = 52 rps`

#### Отправка текущей геолокации водителями

200тыс водителей каждую секунду отправляют сведения о местоположении.

`200000 rps`

#### Итог

Всего rps = 205868 rps

| Заказ такси | Оценка поездки | Прием заказа | Гео        | Всего      |
|-------------|----------------|--------------|------------|------------|
| 52 rps      | 26 rps         | 52 rps       | 200000 rps | 205868 rps |

### Хранение данных

Основная сущности - пользователь, водитель, поездка, отзыв.

Количество пользователей, как говорилось выше - 20 млн, количество водителей - 200 тыс, количество поездок = (количество пользователей * 1.5 примерно каждый день), количество отзывов = (количество пользователей * 1.5 / 2 примерно каждый день).

### Действия пользователей

Для одного пользователя

| Заказ такси     | Оценка поездки     | Прием заказа    |
|-----------------|--------------------|-----------------|
| 1.5 раза в день | 1.5 / 2 раз в день | 1.5 раза в день |

### Сетевой трафик

Отправка геопозиции: Ширина и Долгота имеют размер в 8 байта каждый, так же передаётся id 4 байта.

`20 * 200 тыс = 4 млн байт/c или ~4 млн Мб/день.`

Остальное:

`~400 тыс Мб/день`

## 3. Логическая схема БД
Основные сущности Пользователь, Водитель, Поездка, Отзыв, Местоположение водителя

![](files/logical_db.drawio.png)

В таблице местоположения хранятся записи о координатах водителя за последние сутки.

При заказе такси фронтенд запрашивает водителей с ближайшим геохэшем к своему, который он отправляет с запросом.

Бэкенд рассчитывает маршрут у стороннего сервиса картографии (а-ля Яндекс.Навигатор), возвращает приблизительный маршрут пассажиру и потенциальным водителям.

При преме заказа поездки фронтенд "подписывается" на обновления координат водителя и получает их до конца поездки.

Бэкэнд в этом время тоже "подписывается" на обновления координат водителя для записи маршрута в таблицу поездки.

Во время поездки фронтенд водителя ведет его по маршруту, который получает у стороннего сервиса картографии.


## Источники

* https://marketing.rbc.ru/articles/12202
* https://ru.wikipedia.org/wiki/%D0%A2%D0%B0%D0%BA%D1%81%D0%B8_%D0%B2_%D0%9C%D0%BE%D1%81%D0%BA%D0%B2%D0%B5
* https://vc.ru/transport/184077-deptrans-moskvy-dolya-yandeks-taksi-v-zakazah-za-sutki-vyrosla-do-70-8-v-noyabre-na-3-bolshe-chem-v-iyune
* https://www.vedomosti.ru/business/articles/2020/06/11/832466-yandekstaksi-vezet
* https://rg.ru/2019/10/01/rossiiane-stali-chashche-polzovatsia-uslugami-taksi.html
* https://iz.ru/876402/2019-05-08/nazvana-sredniaia-prodolzhitelnost-poezdki-na-taksi-v-moskve
* https://developers.google.com/maps/documentation/javascript/mysql-to-maps